# AGENTS.md — filename-change プロジェクト用ガイド

本ファイルは AI コーディングエージェント向けの開発ガイドです。開発・テスト・PR 運用の要点を簡潔にまとめています。

## プロジェクト概要
- Windows 向け GUI ツール「ファイル名一括変更」
- 技術: Rust 2021, `druid` GUI, 並列処理に `rayon`, 走査に `walkdir`, 除外に `globset`, 置換に `regex`
- 主要機能:
  - ディレクトリ選択、検索/置換、除外（glob/regex/部分文字列）、サブフォルダ、大小区別
  - プレビュー表示（重複検出、必要に応じ連番付与）
  - 衝突検出のうえ並列でリネーム実行、進捗表示

参考: フォーマット/趣旨は AGENTS.md の提案に準拠しています（`https://github.com/openai/agents.md`）。

## リポジトリ構成
- `src/main.rs`: アプリ起動、ウィンドウ作成、ロギング初期化
- `src/ui.rs`: UI 構築、各種ボタン/リスト/チェックボックスの配置
- `src/state.rs`: `AppState` と `FileEntry` のデータモデル
- `src/preview.rs`: ファイル走査・除外適用・プレビュー更新・連番付与
- `src/rename.rs`: 衝突検出・並列リネーム・進捗/完了メッセージ送出
- `src/controller.rs`: コマンド処理（プレビュー要求/進捗/完了）
- `src/events.rs`: カスタムコマンドセレクタ定義
- `src/widgets.rs`: ハイライトラベル、進捗バー
- `Cargo.toml`: 依存関係
- `操作マニュアル.md`: 仕様/操作説明（ユーザー向け）

## 開発環境メモ
- Rust/Cargo 必須。Windows PowerShell での実行を想定。
- ログ: 既定は `filename_change=debug,druid=warn,druid_shell=off`。環境変数 `RUST_LOG` で変更可。
- 便利コマンド:
  - ビルド: `cargo build`
  - 実行: `cargo run`
  - 例: `RUST_LOG` 明示
    - PowerShell: `$env:RUST_LOG='filename_change=debug,druid=info'; cargo run`

## 実装の要点（安全性・仕様）
- 検索/置換はリテラル前提。`regex` は Exclude とハイライト内部に限定。
- Exclude は 3 系統（glob/regex/部分文字列）を大小無視で評価。
- プレビューで重複件数を算出。`auto_number_on_conflict` 有効時は `(2)`, `(3)`… を付与。
- 適用前に衝突検出（新名の重複、既存ファイルとの衝突）。衝突があれば適用中断。
- リネームは `rayon` で並列化、進捗はカスタムコマンドにより UI 更新。

## テスト指針
- 単体テストは未整備。以下の観点でリグレッション確認:
  - 除外（glob/regex/部分文字列）が意図通り除外される
  - 大文字小文字の切替でプレビュー/ハイライト結果が変わる
  - 連番付与の重複解消が同一ディレクトリ単位で機能
  - 衝突検出が既存ファイル/新名の重複を正しく検知
  - 実リネーム時に進捗・完了メッセージが整合
- 可能であれば `walkdir` でのテスト用一時ディレクトリを作成し、ファイル生成→プレビュー→適用→検証のフローを自動化。

## コーディング規約（サマリ）
- Rust 2021。可読性重視、早期リターン、2 段以上の深いネスト回避。
- 例外/エラーは握り潰さず、`status_message` or ログに反映。
- UI 変更時は `AppState` を経由し、差分があれば `request_update`/`request_paint` を適切に呼ぶ。

## 変更・PR の作法
- ブランチ命名: `feat/*`, `fix/*`, `refactor/*`, `docs/*`
- コミット: 日本語可。1 コミット 1 論点。
- 事前確認:
  - `cargo build` が通ること
  - 実行してプレビュー/適用の主要経路が動作すること
  - `RUST_LOG`=debug でエラー/警告が増えていないこと
- PR テンプレ（タイトル例）: `[feat] 連番付与の UI トグルを追加`

## よくある開発タスク
- 除外仕様の拡張（例: 拡張子ホワイトリスト）
- プレビューの差分強調 UI 改善
- 連番ルールのカスタマイズ（例: サフィックス形式変更）
- エラーハンドリングの詳細表示（失敗パスの一覧化）

## ランタイムの既知の注意
- Windows のファイルシステムは多くが大小無視。拡張子の大小差のみ変更は衝突になり得る。
- ディレクトリのリネーム/移動は対象外（ファイルのみ）。

## 参考
- AGENTS.md の趣旨とサンプルは以下を参照: `https://github.com/openai/agents.md`
- 本リポジトリのユーザー向け詳細は `操作マニュアル.md` を参照。
