## ファイル名一括変更 操作マニュアル

### 概要
指定フォルダ配下のファイル名を、一括で「検索→置換」できます。プレビューで変更結果を確認してから、実際のリネームを適用します。

### 動作環境
- OS: Windows 10 以降
- Rust/Cargo 必須（実行ファイルがある場合は不要）

### ビルド・起動
- ビルド
```powershell
cargo build
```
- 実行（デバッグログ有効）
```powershell
$env:RUST_LOG='filename_change=debug'; cargo run
```
  - 既定では `druid_shell` の内部ログは抑制しています。
  - もっと詳細に見る場合は `RUST_LOG` を上書きします:
```powershell
$env:RUST_LOG='filename_change=debug,druid=info'; cargo run
```

### 画面構成と各項目
- フォルダ: 操作対象ディレクトリのパス。参照ボタンでフォルダ選択。
- 検索: 検索文字列（リテラル一致）。
- 置換: 置換文字列（リテラル置換）。
- 除外: 除外ルール。カンマ区切りで複数指定可。
  - グロブ（glob）: 例 `**/*.log, **/*.tmp, backup/**`
  - 正規表現: `re:` 接頭辞を付ける。例 `re:\.bak$`, `re:(?i)node_modules[\\/]`
  - 素の文字列: ファイル名の部分一致で除外（例 `temp`, `123`）
  - 除外判定は原則パス全体に対して行います（グロブ/正規表現/パス部分文字列）。素の文字列はファイル名に対する部分一致です。すべて大小無視でマッチします。
- 大文字小文字を区別: 大小区別のON/OFF。
- サブフォルダを含める: サブフォルダも再帰的に走査します。
- 重複時に連番を付与: 新名が同一フォルダ内で重複/既存と衝突する場合に、自動で「名前 (2).ext」「名前 (3).ext」...のように連番を付けて一意化します（既定OFF）。
- プレビュー: 現在の入力・設定でプレビューを更新します。
- 変更を適用: プレビュー対象に実リネームを実行します。
- ステータス: 処理状況/件数/エラーなどを表示します。
- 進捗バー: リネーム中の進捗を表示します。

### 基本的な使い方
1) フォルダを指定（または 参照 ボタン）。
2) 検索 と 置換 を入力。
3) 必要に応じて 除外/大文字小文字を区別/サブフォルダを含める を設定。
4) プレビュー を押して、変更結果を確認。
   - チェックボックス（大文字小文字を区別/サブフォルダを含める）を切り替えた場合は自動でプレビューが更新されます。
   - 検索/置換/除外 を編集した際は、プレビュー を押して更新してください。
5) 問題なければ 変更を適用 を押して適用。

### 検索・置換の仕様
- Search はリテラル検索です（パターンではありません）。
  - `Case Sensitive` が OFF の場合、大小無視で一致します。
  - Search が空のときは置換しません（安全対策）。
- Replace はリテラルとしてそのまま置換します（`$1` などの展開はありません）。

### Exclude（除外）の仕様
- 入力はカンマ区切りで複数指定可能。
- 3種類の指定方法を混在できます:
  - グロブ: 例 `**/*.log, **/*.tmp, backup/**`
  - 正規表現: `re:` で始めます。例 `re:\.bak$`, `re:(?i)node_modules[\\/]`
  - 素の文字列: ファイル名の部分一致で除外（例 `temp`, `123`）。パス区切り `/` または `\\` を含む場合は、パス全体の部分一致として評価します。
- グロブ/正規表現はパス全体に対して、素の文字列はファイル名に対して、いずれも大小無視でマッチします。
- 無効なパターンは読み飛ばしますが、`Status` にエラーを表示します（例: `Exclude glob error: ...`, `Exclude regex error: ...`）。

### プレビュー
- プレビューは「現ファイル名 → 新ファイル名」を表示します。
- ステータスには「プレビュー更新 (変更 N 件)」と表示されます。
- 同名へのリネームが複数件発生する場合は重複としてカウントされ、「プレビュー更新 (変更 N 件, 重複 M 件)」と表示します。
- 「重複時に連番を付与」がONの場合、重複は自動で「(2)」「(3)」…の連番が付与されます。ステータスには「プレビュー更新 (変更 N 件, 連番付与 K 件)」と表示されます。
- 重複は「同一フォルダ内での新しいフルパス」が一致した場合のみカウントします。サブフォルダが異なる同名は重複に含めません。

### ハイライト表示機能
- **検索文字列のハイライト**: 元のファイル名リストで、検索フィールドに入力した文字列が黄色でマーカー表示されます。
- **置換結果のハイライト**: プレビューリストで、置換フィールドに入力した文字列（置換結果）が黄色でマーカー表示されます。
- ハイライトは「大文字小文字を区別」の設定に従って動作します。
- 検索フィールドが空の場合はハイライト表示されません。
- 置換フィールドが空（削除）の場合、プレビューではハイライト表示されません。

### 変更の適用（リネーム）
- 適用前に衝突検出を行います。
  - 「新しいパスの重複（同じ新名が複数）」
  - 「すでに同名ファイルが存在」
  - Windows では大小無視のため、大小違いのみでも衝突とみなすことがあります。
- 衝突がある場合は適用を中断し、ステータスに「衝突を検出: 新名の重複 X 件、既存ファイルとの衝突 Y 件」と表示します。
- 衝突の対処:
  - Search/Replace を調整する
  - Exclude で一部を除外する
  - Case Sensitive を切り替える
  - 段階的に複数回に分けて実行する
- 適用完了後は「リネーム N 件、エラー M 件」という完了ダイアログが表示されます。

### デバッグログの見方
- 代表的なログ
  - `loaded_files: ...` 読み込んだ件数
  - `excluded by glob/regex` 除外ルールで弾かれたパス
  - `preview_rename` 1件ごとのプレビュー置換結果
  - `collision_detected` 衝突の詳細
- 既定ログフィルタ
  - `filename_change=debug,druid=warn,druid_shell=off`
- 例: ログをより冗長にする
```powershell
$env:RUST_LOG='filename_change=debug,druid=info'; cargo run
```

### よく使うレシピ
- 拡張子を tif → png に置換（単純な文字列置換）
  - Search: `.tif`
  - Replace: `.png`
  - 注: ファイル名の途中に含まれる `.tif` も置換されます。必要に応じて Exclude で調整してください。
- 接頭辞の削除（例: `IMG_` を外す）
  - Search: `IMG_`
  - Replace: ``（空）
- 記号の正規化（例: 全角ハイフンを半角に）
  - Search: `－`
  - Replace: `-`

### トラブルシューティング
- フォルダを選んでもファイルが表示されない
  - フォルダにファイルが無い、または全件が Exclude に一致している可能性
  - Exclude を一時的に空にして Preview を実行
- `Exclude glob error:` / `Exclude regex error:`
  - Exclude のパターンが無効。該当部分を修正
- 「衝突を検出: ...」
  - 新名の重複または既存同名
  - 検索/置換/除外 を調整、または複数回に分けて実行
- リネームでエラー（完了メッセージにエラー件数が表示される）
  - OSの権限やウイルス対策ソフトによりファイルがロックされている可能性
  - 対象ファイルを閉じてから再試行

### 既知の注意点
- ディレクトリ自体のリネームや移動は対象外（ファイルのみ）。
- Windows では大小無視のため、大小違いのみの変更は衝突とみなされる場合があります。
- 非ASCII/特殊文字を含むファイル名でも基本対応していますが、エクスプローラの表示と差異が出る場合はあります。

### バージョン情報
- アプリ: filename-change 0.1.0
- ライブラリ主要バージョン: druid 0.8.x, regex 1.10+, globset 0.4+, rayon 1.6+




